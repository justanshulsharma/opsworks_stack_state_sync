######################### ElasticSearch Configuration  ########################

# This file is managed by Chef, do not edit manually, your changes *will* be overwritten!
#
# Please see the source file for context and more information:
#
# https://github.com/elasticsearch/elasticsearch/blob/master/config/elasticsearch.yml
#
# To set configurations not exposed by this template, set the
# `node.elasticsearch[:custom_config]` attribute in your node configuration,
# `elasticsearch/settings` data bag, role/environment definition, etc:
#
#     // ...
#     'threadpool.index.type' => 'fixed',
#     'threadpool.index.size' => '2'
#     // ...

################################### Cluster ###################################

cluster.name: dcaela-search-cluster

#################################### Node #####################################

node.name: <%= @localhost_name %>.localdomain
node.max_local_storage_nodes: 1

#################################### Index ####################################

index.mapper.dynamic: true
action.auto_create_index: true
action.disable_delete_all_indices: true

#################################### Paths ####################################

path.conf: /usr/local/etc/elasticsearch
path.data: /mnt/elasticsearch-data
path.logs: /usr/local/var/log/elasticsearch

#################################### Plugin ###################################


################################### Memory ####################################

bootstrap.mlockall: true

############################## Network And HTTP ###############################

http.port: 9200

################################### Gateway ###################################

gateway.expected_nodes: <%= @nodes.length %>

############################# Recovery Throttling #############################


################################## Discovery ##################################

discovery.type: ec2

discovery.zen.minimum_master_nodes: <%= (@nodes.length / 2).floor + 1 -%>


discovery.zen.ping.multicast.enabled: false

cloud.node.auto_attributes: true
cloud.aws.region: us-east-1
discovery.ec2.tag.opsworks:stack: dcaela-search

<% results = [] -%>
<% @nodes.each do |node| -%>
<% if node.attributes.attribute?(:private_ip) && node.attributes.private_ip && Resolv.getaddress(node.attributes.private_ip) -%>
  <% results << node.name %>
<% end -%>
<% end -%>

discovery.zen.ping.unicast.hosts: <%= results %>

################################## Slow Log ###################################


################################## GC Logging #################################


################################## JMX ########################################


################################## Custom #####################################

cluster.routing.allocation.awareness.attributes: rack_id
index:
  analysis:
    analyzer:
      default_index:
        filter:
        - standard
        - lowercase
        - snowball
        tokenizer: standard
      default_search:
        tokenizer: standard
        filter:
        - standard
        - lowercase
        - snowball
        
node.rack_id: <%= node[:opsworks][:instance][:availability_zone] -%>
